#include "font.h"
#include "uart.h"



   

// 16x16 font data for digits 0-9
__code u8 font_16x16_data[FONT_16X16_CHAR_COUNT][FONT_16X16_BYTES_PER_CHAR] = {
    // Character 0: Number "0"
    {0x0F, 0xFC, 0x1F, 0xFE, 0x1F, 0xFE, 0x3F, 0x3E,
    0x3F, 0x3E, 0x3F, 0x3E, 0x3E, 0x7E, 0x7E, 0x7E,
    0x7E, 0x7E, 0x7E, 0x7C, 0x7C, 0xFC, 0x7C, 0xFC,
    0x7C, 0xFC, 0x7F, 0xF8, 0x7F, 0xF8, 0x3F, 0xF0},
    
    // Character 1: Number "1"
    {0x03, 0xFE, 0x07, 0xFE, 0x0F, 0xFE, 0x1F, 0xFC,
    0x1F, 0xFC, 0x00, 0xFC, 0x00, 0xFC, 0x00, 0xF8,
    0x01, 0xF8, 0x01, 0xF8, 0x01, 0xF8, 0x01, 0xF0,
    0x03, 0xF0, 0x03, 0xF0, 0x03, 0xF0, 0x07, 0xE0},
    
    // Character 2: Number "2"
    {0x0F, 0xFF, 0x1F, 0xFF, 0x1F, 0xFF, 0x1F, 0xFF,
    0x00, 0x3F, 0x00, 0x3F, 0x1F, 0xFE, 0x3F, 0xFE,
    0x7F, 0xF8, 0x7F, 0xF0, 0xFC, 0x00, 0xFC, 0x00,
    0xFF, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
    
    // Character 3: Number "3"
    {0x07, 0xFF, 0x0F, 0xFF, 0x0F, 0xFF, 0x0F, 0xFF,
    0x00, 0x1F, 0x00, 0x1F, 0x01, 0xFE, 0x03, 0xFC,
    0x03, 0xFE, 0x03, 0xFF, 0x00, 0x7F, 0x00, 0x7F,
    0x3F, 0xFF, 0x7F, 0xFE, 0xFF, 0xFE, 0xFF, 0xFC},
    
    // Character 4: Number "4"
    {0x3F, 0x1F, 0x3F, 0x3F, 0x3E, 0x3F, 0x7E, 0x3F,
    0x7E, 0x3E, 0x7E, 0x7E, 0x7C, 0x7E, 0xFF, 0xFE,
    0xFF, 0xFC, 0xFF, 0xFC, 0x7F, 0xFC, 0x3F, 0xFC,
    0x00, 0xF8, 0x01, 0xF8, 0x01, 0xF8, 0x01, 0xF8},
    
    // Character 5: Number "5"
    {0x0F, 0xFF, 0x0F, 0xFF, 0x0F, 0xFF, 0x1F, 0xFF,
    0x1F, 0x80, 0x1F, 0x80, 0x1F, 0xFC, 0x3F, 0xFE,
    0x3F, 0xFE, 0x3F, 0xFE, 0x00, 0x7E, 0x00, 0x7E,
    0x3F, 0xFE, 0x7F, 0xFC, 0xFF, 0xFC, 0xFF, 0xF8},
    
    // Character 6: Number "6"
    {0x0F, 0xFF, 0x1F, 0xFF, 0x1F, 0xFF, 0x3F, 0x3F,
    0x3F, 0x00, 0x3F, 0xF8, 0x3F, 0xFC, 0x7F, 0xFE,
    0x7F, 0xFE, 0x7E, 0x7E, 0xFC, 0x7E, 0xFC, 0xFE,
    0xFF, 0xFE, 0xFF, 0xFC, 0xFF, 0xF8, 0xFF, 0xF0},
    
    // Character 7: Number "7"
    {0x0F, 0xFF, 0x1F, 0xFF, 0x1F, 0xFF, 0x1F, 0xFE,
    0x00, 0x7E, 0x00, 0xFC, 0x01, 0xF8, 0x01, 0xF8,
    0x03, 0xF0, 0x07, 0xE0, 0x07, 0xC0, 0x0F, 0xC0,
    0x1F, 0x80, 0x3F, 0x00, 0x3F, 0x00, 0x7E, 0x00},
    
    // Character 8: Number "8"
    {0x0F, 0xFE, 0x1F, 0xFF, 0x1F, 0xFF, 0x3F, 0x3F,
    0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0xFE, 0x1F, 0xF8,
    0x3F, 0xFC, 0x7F, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC,
    0xFC, 0xFC, 0xFF, 0xF8, 0xFF, 0xF8, 0xFF, 0xF0},
    
    // Character 9: Number "9"
    {0x0F, 0xFE, 0x1F, 0xFF, 0x1F, 0xFF, 0x3F, 0x3F,
    0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0xFE, 0x3F, 0xFE,
    0x3F, 0xFE, 0x1F, 0xFC, 0x00, 0xFC, 0xF8, 0xFC,
    0xFF, 0xFC, 0xFF, 0xF8, 0xFF, 0xF8, 0xFF, 0xF0}
};

// Forward declarations for LCD functions



// Function to render a 16x16 character
void render_16x16_char(u8 x, u8 y, char c) {
    if (c < '0' || c > '9') return;
    u8 idx = c - '0';

    // IMPORTANT: explicit code-space pointer
    const __code u8 *glyph = &font_16x16_data[idx][0];

    lcd_set_window(x, y, x + FONT_16X16_WIDTH - 1, y + FONT_16X16_HEIGHT - 1);

    for (u8 row = 0; row < FONT_16X16_HEIGHT; row++) {
        // two bytes per row: left 8, right 8
        u8 b0 = glyph[row * 2 + 0];
        u8 b1 = glyph[row * 2 + 1];
        u16 row_data = ((u16)b0 << 8) | b1; // MSB = leftmost pixel

        for (u8 col = 0; col < FONT_16X16_WIDTH; col++) {
            if (row_data & (0x8000 >> col)) {
                lcd_send_data(0xFF); // white hi
                lcd_send_data(0xFF); // white lo
            } else {
                lcd_send_data(0x00); // black hi
                lcd_send_data(0x00); // black lo
            }
        }
    }
}


// Render a string using 16x16 font
void render_16x16_string(u8 x, u8 y, const char *str) {
    u8 current_x = x;
    
    while (*str && current_x < DISPLAY_WIDTH - FONT_16X16_WIDTH) {
        if (*str >= '0' && *str <= '9') {
            render_16x16_char(current_x, y, *str);
            current_x += FONT_16X16_WIDTH + 2; // Add 2 pixel spacing
        }
        str++;
    }
}



// Render a number using 16x16 font
static const u16 powers_of_10[] = {10000, 1000, 100, 10, 1};

void render_16x16_number(u8 x, u8 y, u16 number) {
    u8 started = 0;
    for (u8 p = 0; p < 5; p++) {
        u8 digit = 0;
        while (number >= powers_of_10[p]) {
            number -= powers_of_10[p];
            digit++;
        }
        if (digit || started || p == 4) {
            render_16x16_char(x, y, '0' + digit);
            x += FONT_16X16_WIDTH + 2;
            started = 1;
        }
    }
}






// Clear a rectangular area of the display
void clear_area(u8 x1, u8 y1, u8 x2, u8 y2) {
    lcd_set_window(x1, y1, x2, y2);
    
    u16 pixel_count = (u16)(x2 - x1 + 1) * (y2 - y1 + 1);
    for (u16 i = 0; i < pixel_count; i++) {
        lcd_send_data(0x00);  // Black background
        lcd_send_data(0x00);
    }
}

// Demonstration of both fonts
void dual_font_demo(void) {
    // Clear the display
    clear_area(0, 0, DISPLAY_WIDTH - 1, DISPLAY_HEIGHT - 1);
    
    // Display using 16x16 font
    render_16x16_string(5, 5, "16x16:");
    render_16x16_string(10, 25, "123456");
    render_16x16_number(10, 45, 7890);

}

// Test individual fonts
void test_fonts_separate(void) {
    // Test 16x16 font
    clear_area(0, 0, 79, 127);
    render_16x16_string(5, 10, "16x16");
    render_16x16_string(5, 30, "01234");
    render_16x16_string(5, 50, "56789");
    render_16x16_number(5, 70, 2024);
    
}